extends ../tutorial.pug

block title
  | Chapter 9: Exception Handling - F4 Framework Tutorial

block content
  .chapter-header
    .chapter-number Chapter 9
    h1 Exception Handling
    p.description Master error handling and create robust applications

  .content-section
    h2 Introduction

    p Exception handling is crucial for building reliable applications. F4 provides a flexible system for catching and handling exceptions at different levels, allowing you to respond appropriately to errors and provide meaningful feedback to users.

    h3 What We'll Cover

    ul
      li Global exception handlers
      li HTTP exceptions with status codes
      li Route-level exception handling
      li Validation exceptions
      li Custom error pages
      li Development vs production mode
      li Logging and debugging
      li Best practices

  .content-section
    h2 Exception Handler Basics

    p F4 lets you register exception handlers using the <code>on()</code> method:

    pre
      code.language-php.
        use F4\Core\Exception\HttpException;

        // Global exception handler
        $f4->on(HttpException::class,
            function($exception, $request, $response, $route) {
                return $response
                    ->setData(['error' => $exception->getMessage()])
                    ->withStatus($exception->getCode());
            }
        );

    .info-box
      strong Key Concept:
      | Exception handlers catch exceptions and transform them into appropriate responses.

  .content-section
    h2 HTTP Exceptions

    p <code>HttpException</code> is used for HTTP errors with status codes:

    h3 Common HTTP Status Codes

    table
      thead
        tr
          th Code
          th Meaning
          th Use Case
      tbody
        tr
          td 400
          td Bad Request
          td Invalid input data
        tr
          td 401
          td Unauthorized
          td Authentication required
        tr
          td 403
          td Forbidden
          td Insufficient permissions
        tr
          td 404
          td Not Found
          td Resource doesn't exist
        tr
          td 422
          td Unprocessable Entity
          td Validation failed
        tr
          td 500
          td Internal Server Error
          td Unexpected server error
        tr
          td 503
          td Service Unavailable
          td Maintenance mode

    h3 Throwing HTTP Exceptions

    pre
      code.language-php.
        use F4\Core\Exception\HttpException;

        // 404 Not Found
        Route::get('/posts/{id:int}', function(int $id) {
            $post = Post::find($id);

            if (!$post) {
                throw new HttpException('Post not found', 404);
            }

            return ['post' => $post];
        });

        // 403 Forbidden
        Route::delete('/posts/{id:int}', function(int $id) {
            if (!isAdmin()) {
                throw new HttpException('Admin access required', 403);
            }

            Post::delete($id);
            return ['success' => true];
        });

  .content-section
    h2 Global Exception Handlers

    p Register handlers for different exception types:

    pre
      code.language-php.
        use F4\Core\Exception\{HttpException, ValidationFailedException};
        use F4\DB\Exception\DatabaseException;

        // Handle HTTP exceptions
        $f4->on(HttpException::class,
            function($exception, $request, $response, $route) {
                return $response
                    ->setData([
                        'error' => $exception->getMessage(),
                        'code' => $exception->getCode()
                    ])
                    ->withStatus($exception->getCode());
            }
        );

        // Handle validation errors
        $f4->on(ValidationFailedException::class,
            function($exception, $request, $response, $route) {
                return $response
                    ->setData([
                        'error' => 'Validation failed',
                        'errors' => $exception->getErrors()
                    ])
                    ->withStatus(422);
            }
        );

        // Handle database errors
        $f4->on(DatabaseException::class,
            function($exception, $request, $response, $route) {
                error_log("Database error: " . $exception->getMessage());

                return $response
                    ->setData(['error' => 'Database error occurred'])
                    ->withStatus(500);
            }
        );

        // Catch-all for unexpected exceptions
        $f4->on(\Exception::class,
            function($exception, $request, $response, $route) {
                error_log("Unexpected error: " . $exception->getMessage());

                return $response
                    ->setData(['error' => 'An unexpected error occurred'])
                    ->withStatus(500);
            }
        );

  .content-section
    h2 Route-Level Exception Handlers

    p Handle exceptions for specific routes:

    pre
      code.language-php.
        $f4->addRoute(
            Route::get('/api/data', function() {
                throw new \Exception('Something went wrong');
            })
            ->on(\Exception::class,
                function($exception, $request, $response) {
                    // Route-specific error handling
                    return $response
                        ->setData(['error' => 'API error'])
                        ->withStatus(500);
                }
            )
        );

    .info-box
      strong Priority:
      | Route-level handlers take precedence over global handlers.

  .content-section
    h2 Validation Exceptions

    p <code>ValidationFailedException</code> is thrown automatically when parameter validation fails:

    pre
      code.language-php.
        use F4\Core\Validator\{IsNotEmpty, IsEmail};

        Route::post('/register', function(
            #[IsNotEmpty]
            string $name,

            #[IsEmail]
            string $email
        ) {
            // If validation fails, ValidationFailedException is thrown
            // Your handler can return a 422 response with error details
            return ['success' => true];
        });

    h3 Validation Error Format

    pre
      code.language-json.
        // Exception handler response
        {
            "error": "Validation failed",
            "errors": {
                "email": ["Email address is invalid"],
                "name": ["Name cannot be empty"]
            }
        }

  .content-section
    h2 Custom Error Pages

    p Create custom templates for different error codes:

    h3 404 Error Page

    pre
      code.language-php.
        $f4->on(HttpException::class,
            function($exception, $request, $response, $route) {
                $code = $exception->getCode();

                // Use custom template for 404 errors
                if ($code === 404) {
                    return $response
                        ->setTemplate('errors/404.pug')
                        ->setData(['message' => $exception->getMessage()])
                        ->withStatus(404);
                }

                // Generic error page
                return $response
                    ->setTemplate('errors/generic.pug')
                    ->setData([
                        'code' => $code,
                        'message' => $exception->getMessage()
                    ])
                    ->withStatus($code);
            }
        );

  .content-section
    h2 Handling 404 Routes

    p Handle requests to non-existent routes:

    pre
      code.language-php.
        $f4->after(function($response, $request, $route) {
            // If no route matched
            if (!$route) {
                return $response
                    ->setTemplate('errors/404.pug')
                    ->setData(['error' => 'Page not found'])
                    ->withStatus(404);
            }

            return $response;
        });

  .content-section
    h2 Development vs Production

    p Show different error information based on environment:

    pre
      code.language-php.
        use F4\Config;

        $f4->on(\Exception::class,
            function($exception, $request, $response, $route) {
                // Log error
                error_log($exception->getMessage());
                error_log($exception->getTraceAsString());

                $data = ['error' => 'An error occurred'];

                // Show details in development mode
                if (Config::DEBUG_MODE) {
                    $data['message'] = $exception->getMessage();
                    $data['file'] = $exception->getFile();
                    $data['line'] = $exception->getLine();
                    $data['trace'] = $exception->getTrace();
                }

                return $response
                    ->setData($data)
                    ->withStatus(500);
            }
        );

    .warning-box
      strong Security:
      | Never expose stack traces or sensitive error details in production!

  .content-section
    h2 Exception Handler Parameters

    p All exception handlers receive four parameters:

    table
      thead
        tr
          th Parameter
          th Type
          th Description
      tbody
        tr
          td
            code $exception
          td Exception
          td The caught exception
        tr
          td
            code $request
          td Request
          td Current HTTP request
        tr
          td
            code $response
          td Response
          td Response to modify
        tr
          td
            code $route
          td Route|null
          td Matched route (if any)

  .content-section
    h2 Exception Hierarchy

    p F4 exception hierarchy:

    .demo-box
      pre.
        Exception (PHP base)
        └── F4\Core\Exception\HttpException
        └── F4\Core\Exception\ValidationFailedException
        └── F4\DB\Exception\DatabaseException
            ├── ConnectionException
            ├── QueryException
            └── TransactionException

  .content-section
    h2 Logging Exceptions

    p Implement comprehensive error logging:

    pre
      code.language-php.
        $f4->on(\Exception::class,
            function($exception, $request, $response, $route) {
                // Log comprehensive error information
                $logMessage = sprintf(
                    "[%s] %s: %s in %s:%d\nRequest: %s %s\nTrace:\n%s",
                    date('Y-m-d H:i:s'),
                    get_class($exception),
                    $exception->getMessage(),
                    $exception->getFile(),
                    $exception->getLine(),
                    $request->getMethod(),
                    $request->getPath(),
                    $exception->getTraceAsString()
                );

                error_log($logMessage);

                return $response
                    ->setData(['error' => 'Server error'])
                    ->withStatus(500);
            }
        );

  .content-section
    h2 Complete Error Handling Example

    pre
      code.language-php.
        use F4\Core\Exception\{HttpException, ValidationFailedException};
        use F4\Config;

        class ErrorHandlerModule implements ModuleInterface
        {
            public function __construct(CoreApiInterface &$f4)
            {
                // Validation errors
                $f4->on(ValidationFailedException::class,
                    function($e, $req, $res) {
                        return $res
                            ->setData([
                                'error' => 'Validation failed',
                                'errors' => $e->getErrors()
                            ])
                            ->withStatus(422);
                    }
                );

                // HTTP errors (404, 403, etc.)
                $f4->on(HttpException::class,
                    function($e, $req, $res) {
                        $code = $e->getCode();

                        if ($code === 404) {
                            return $res
                                ->setTemplate('errors/404.pug')
                                ->setData(['message' => $e->getMessage()])
                                ->withStatus(404);
                        }

                        return $res
                            ->setData(['error' => $e->getMessage()])
                            ->withStatus($code);
                    }
                );

                // Catch-all for unexpected errors
                $f4->on(\Exception::class,
                    function($e, $req, $res) {
                        error_log($e->getMessage());

                        $data = ['error' => 'Internal server error'];

                        if (Config::DEBUG_MODE) {
                            $data['debug'] = [
                                'message' => $e->getMessage(),
                                'file' => $e->getFile(),
                                'line' => $e->getLine()
                            ];
                        }

                        return $res
                            ->setData($data)
                            ->withStatus(500);
                    }
                );

                // Handle 404 for unmatched routes
                $f4->after(function($res, $req, $route) {
                    if (!$route) {
                        return $res
                            ->setTemplate('errors/404.pug')
                            ->setData(['error' => 'Page not found'])
                            ->withStatus(404);
                    }
                    return $res;
                });
            }
        }

  .content-section
    h2 Best Practices

    ol
      li Always log exceptions for debugging
      li Use appropriate HTTP status codes
      li Hide sensitive details in production
      li Provide helpful error messages to users
      li Create custom error pages for common codes
      li Handle validation errors with 422 status
      li Use specific exception types when possible
      li Don't catch exceptions you can't handle
      li Test error scenarios thoroughly
      li Monitor error rates in production

  .content-section
    h2 Common HTTP Status Codes Reference

    table
      thead
        tr
          th Code
          th Name
          th When to Use
      tbody
        tr
          td 400
          td Bad Request
          td Malformed request syntax
        tr
          td 401
          td Unauthorized
          td Authentication required
        tr
          td 403
          td Forbidden
          td Authenticated but not authorized
        tr
          td 404
          td Not Found
          td Resource doesn't exist
        tr
          td 405
          td Method Not Allowed
          td Wrong HTTP method
        tr
          td 422
          td Unprocessable Entity
          td Validation failed
        tr
          td 429
          td Too Many Requests
          td Rate limit exceeded
        tr
          td 500
          td Internal Server Error
          td Unexpected server error
        tr
          td 503
          td Service Unavailable
          td Maintenance or overload

  .content-section
    h2 Try It Yourself

    p Practice exercises:

    ol
      li Create custom 404 and 500 error pages
      li Implement a validation error handler for forms
      li Add logging for all exceptions
      li Build a maintenance mode with 503 responses
      li Test error handling in different formats (.json, .html)

  .content-section
    h2 Key Takeaways

    ul
      li Use
        code $f4->on()
        |  to register exception handlers
      li
        code HttpException
        |  for HTTP errors with status codes
      li
        code ValidationFailedException
        |  for validation errors
      li Route-level handlers override global handlers
      li Always log exceptions for debugging
      li Hide sensitive details in production
      li Use custom error pages for better UX
      li Handle 404s with after middleware
      li Use appropriate HTTP status codes
      li Test error scenarios thoroughly

  .content-section
    h2 What's Next?

    p Now that you understand exception handling, continue to the next chapter to learn about configuration management and how F4 handles different environments!
