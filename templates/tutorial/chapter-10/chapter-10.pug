extends ../tutorial.pug

block title
  | Chapter 10: Configuration - F4 Framework Tutorial

block content
  .chapter-header
    .chapter-number Chapter 10
    h1 Configuration Management
    p.description Master F4's configuration system, environment management, and best practices

  .content-section
    h2 Introduction

    p F4 uses a powerful class-based configuration system that allows you to manage settings across different environments. All configuration is done through PHP constants in a configuration class that extends <code>AbstractConfig</code>.

    h3 What We'll Cover

    ul
      li Configuration class structure
      li Environment-specific configuration
      li Reading configuration values from environment variables
      li Reading configuration from INI files
      li Database configuration
      li Template and session settings
      li Module registration
      li Best practices for secure configuration

  .content-section
    h2 Configuration Class Structure

    p F4 configuration is based on extending <code>AbstractConfig</code> which provides default values for all framework settings:

    pre
      code.language-php.
        namespace F4;

        use F4\AbstractConfig;

        class Config extends AbstractConfig
        {
            // Override default settings by defining constants
            public const bool DEBUG_MODE = false;

            public const array MODULES = [
                \App\Example::class
            ];

            public const array TEMPLATE_PATHS = [
                __DIR__ . '/../templates'
            ];
        }

    .info-box
      strong Key Concept:
      |  
      | Configuration is done through class constants, which provides global availability, including default argument values for methods, while maintaining type safety and language-enforced immutability of configuration parameters.

  .content-section
    h2 Environment-Based Configuration

    p F4 uses a flexible environment system that allows different configuration files to be loaded based on the <code>F4_ENVIRONMENT</code> environment variable.

    h3 Environment Configuration in composer.json

    p Environments are defined in your project's <code>composer.json</code> file under the <code>extra.f4.environments</code> section:

    pre
      code.language-json.
        {
          "extra": {
            "f4": {
              "environments": {
                "production": {
                  "config": "config/production.php"
                },
                "test": {
                  "config": "config/test.php"
                },
                "local": {
                  "config": "config/local.php",
                  "server": "localhost:8080"
                },
                "default": {
                  "config": "config/default.php"
                }
              }
            }
          }
        }

    h3 Environment Priority and Loading

    p F4 loads configuration files based on a priority system. In your bootstrap file (<code>public/index.php</code>), you specify which environments to try:

    pre
      code.language-php.
        Loader::loadEnvironmentConfig(
            environments: [($_SERVER['F4_ENVIRONMENT'] ?? null) ?: 'local', 'default']
        );

    p This configuration attempts to load environments in the following order:

    ol
      li <strong>F4_ENVIRONMENT value</strong> - If the <code>F4_ENVIRONMENT</code> environment variable is set, F4 tries to load that environment first
      li <strong>'local'</strong> - If F4_ENVIRONMENT is not set or that environment's config file doesn't exist, try 'local'
      li <strong>'default'</strong> - If 'local' doesn't exist, fall back to 'default'

    .info-box
      strong How It Works:
      | F4 iterates through the environments array and loads the <strong>first</strong> configuration file it finds. Once a file is loaded, the search stops.

    h3 Setting the Environment

    .demo-box
      h4 Option 1: Environment Variable

      pre
        code.language-bash.
          # Linux/macOS
          export F4_ENVIRONMENT=production
          php -S localhost:8080 -t public/

          # Windows
          set F4_ENVIRONMENT=production
          php -S localhost:8080 -t public/

      h4 Option 2: Web Server Configuration

      pre
        code.language-bash.
          # Apache (.htaccess)
          SetEnv F4_ENVIRONMENT production

          # Nginx
          fastcgi_param F4_ENVIRONMENT production;

      h4 Option 3: Docker

      pre
        code.language-yaml.
          # docker-compose.yml
          services:
            app:
              environment:
                - F4_ENVIRONMENT=production

  .content-section
    h2 Configuration File Locations

    p Based on the environment system, F4 typically uses these configuration files:

    table
      thead
        tr
          th File
          th Purpose
          th When Loaded
      tbody
        tr
          td
            code config/default.php
          td Base configuration for all environments
          td Fallback when no other config exists
        tr
          td
            code config/local.php
          td Local development configuration
          td Default for local development
        tr
          td
            code config/production.php
          td Production configuration
          td When F4_ENVIRONMENT=production
        tr
          td
            code config/test.php
          td Test environment configuration
          td When F4_ENVIRONMENT=test
        tr
          td
            code config/local.example.php
          td Example configuration template
          td Never loaded (template only)

    h3 Example: default.php

    pre
      code.language-php.
        namespace F4;

        use App\Tutorial\TutorialModule;
        use F4\AbstractConfig;

        class Config extends AbstractConfig
        {
            public const array MODULES = [
                TutorialModule::class
            ];

            public const array TEMPLATE_PATHS = [
                __DIR__ . '/../templates'
            ];

            public const string DEFAULT_TEMPLATE = 'index.pug';
        }

    h3 Example: local.php

    pre
      code.language-php.
        namespace F4;

        use F4\AbstractConfig;

        // Local config overrides default.php
        class Config extends AbstractConfig
        {
            public const bool DEBUG_MODE = true;

            public const string DB_HOST = 'localhost';
            public const string DB_NAME = 'myapp_dev';
            public const string DB_USERNAME = 'dev_user';
            public const string DB_PASSWORD = 'dev_pass';
        }

    .warning-box
      strong Security:
      | Never commit <code>local.php</code> to version control! Add it to <code>.gitignore</code> to prevent exposing sensitive credentials.

  .content-section
    h2 Environment Variables

    p F4 supports reading configuration from environment variables using the <code>\#[ENV]</code> attribute:

    pre
      code.language-php.
        namespace F4;

        use F4\AbstractConfig;
        use F4\Config\FromEnvironmentVariable as ENV;

        class Config extends AbstractConfig
        {
            // Read from F4_DEBUG_MODE environment variable
            #[ENV(name: 'F4_DEBUG_MODE')]
            public const bool DEBUG_MODE = true;

            // Read database credentials from environment
            #[ENV(name: 'DATABASE_HOST')]
            public const string DB_HOST = parent::DB_HOST;

            #[ENV(name: 'DATABASE_NAME')]
            public const string DB_NAME = '';

            #[ENV(name: 'DATABASE_USER')]
            public const string DB_USERNAME = '';

            #[ENV(name: 'DATABASE_PASSWORD')]
            public const string DB_PASSWORD = '';
        }

    h3 Setting Environment Variables

    .demo-box
      h4 .env file (development)

      pre.
        F4_DEBUG_MODE=true
        DATABASE_HOST=localhost
        DATABASE_NAME=myapp
        DATABASE_USER=dbuser
        DATABASE_PASSWORD=secret

      h4 Docker environment

      pre.
        docker run -e F4_DEBUG_MODE=false \\
                   -e DATABASE_HOST=postgres \\
                   -e DATABASE_NAME=production \\
                   myapp:latest

    .info-box
      strong Best Practice:
      | Use environment variables for secrets and environment-specific settings. Use config constants for application structure and defaults.

  .content-section
    h2 INI Files

    p F4 can read configuration from INI files using the <code>\#[INI]</code> attribute:

    pre
      code.language-php.
        use F4\Config\FromIniFile as INI;

        class Config extends AbstractConfig
        {
            #[INI(name: 'TEMPLATE_CACHE_LIFETIME', file: 'local-settings.ini')]
            public const int TEMPLATE_CACHE_LIFETIME = parent::TEMPLATE_CACHE_LIFETIME;

            #[INI(name: 'APP_NAME', file: 'app.ini')]
            public const string DB_APP_NAME = null;
        }

    h3 INI File Format

    .demo-box
      h4 local-settings.ini

      pre.
        TEMPLATE_CACHE_LIFETIME=7200
        APP_NAME="My Application"

  .content-section
    h2 Common Configuration Options

    h3 Debug Mode

    table
      thead
        tr
          th Constant
          th Type
          th Description
          th Default
      tbody
        tr
          td
            code DEBUG_MODE
          td bool
          td Enable debug mode
          td false
        tr
          td
            code DEBUG_DB_QUERIES
          td bool
          td Log database queries
          td true
        tr
          td
            code DEBUG_EXTENSION
          td string
          td URL suffix for debugger
          td '+debug'

    pre
      code.language-php.
        public const bool DEBUG_MODE = true;
        public const string DEBUG_EXTENSION = '+debug';

    h3 Database Configuration

    table
      thead
        tr
          th Constant
          th Type
          th Description
      tbody
        tr
          td
            code DB_HOST
          td string
          td Database server host
        tr
          td
            code DB_PORT
          td string
          td Database server port
        tr
          td
            code DB_NAME
          td string
          td Database name
        tr
          td
            code DB_USERNAME
          td string
          td Database username
        tr
          td
            code DB_PASSWORD
          td string
          td Database password
        tr
          td
            code DB_SCHEMA
          td string
          td PostgreSQL schema
        tr
          td
            code DB_CHARSET
          td string
          td Connection charset
        tr
          td
            code DB_PERSIST
          td bool
          td Use persistent connections

    pre
      code.language-php.
        public const string DB_HOST = 'localhost';
        public const string DB_PORT = '5432';
        public const string DB_NAME = 'myapp';
        public const string DB_USERNAME = 'dbuser';
        public const string DB_PASSWORD = 'secret';
        public const string DB_SCHEMA = 'public';
        public const bool DB_PERSIST = true;

    h3 Template Configuration

    table
      thead
        tr
          th Constant
          th Type
          th Description
      tbody
        tr
          td
            code TEMPLATE_PATHS
          td array
          td Template search paths
        tr
          td
            code DEFAULT_TEMPLATE
          td string
          td Default template file
        tr
          td
            code TEMPLATE_CACHE_ENABLED
          td bool
          td Enable template caching
        tr
          td
            code TEMPLATE_CACHE_PATH
          td string
          td Cache directory path
        tr
          td
            code TEMPLATE_CACHE_LIFETIME
          td int
          td Cache lifetime in seconds

    pre
      code.language-php.
        public const array TEMPLATE_PATHS = [
            __DIR__ . '/../templates'
        ];
        public const string DEFAULT_TEMPLATE = 'index.pug';
        public const bool TEMPLATE_CACHE_ENABLED = true;
        public const string TEMPLATE_CACHE_PATH = '/tmp/f4-cache';
        public const int TEMPLATE_CACHE_LIFETIME = 3600;

    h3 Session Configuration

    table
      thead
        tr
          th Constant
          th Type
          th Description
      tbody
        tr
          td
            code SESSION_ENABLED
          td bool
          td Enable session support
        tr
          td
            code SESSION_COOKIE_NAME
          td string
          td Session cookie name
        tr
          td
            code SESSION_LIFETIME
          td string
          td Session lifetime
        tr
          td
            code SESSION_SECURE_ONLY
          td bool
          td HTTPS-only cookies
        tr
          td
            code SESSION_HTTP_ONLY
          td bool
          td HTTP-only cookies
        tr
          td
            code SESSION_SAME_SITE
          td string
          td SameSite policy

    pre
      code.language-php.
        public const bool SESSION_ENABLED = true;
        public const string SESSION_COOKIE_NAME = 'F4_SESSION_ID';
        public const bool SESSION_SECURE_ONLY = true;
        public const bool SESSION_HTTP_ONLY = true;
        public const string SESSION_SAME_SITE = 'Strict';

  .content-section
    h2 Module Registration

    p Register modules in the <code>MODULES</code> array:

    pre
      code.language-php.
        public const array MODULES = [
            \App\Auth\AuthModule::class,
            \App\Blog\BlogModule::class,
            \App\Admin\AdminModule::class,
        ];

    .info-box
      strong Module Order:
      | Modules are loaded in the order they appear in the array. This affects route registration and middleware order.

  .content-section
    h2 Response Format Configuration

    p Configure response emitters for different content types:

    pre
      code.language-php.
        public const string DEFAULT_RESPONSE_FORMAT = 'text/html';

        public const array RESPONSE_EMITTERS = [
            'text/html' => [
                'extensions' => ['.html', '.htm'],
                'class' => \F4\Core\ResponseEmitter\Html::class,
            ],
            'application/json' => [
                'extensions' => ['.json'],
                'class' => \F4\Core\ResponseEmitter\Json::class,
            ],
        ];

  .content-section
    h2 Locale and i18n Configuration

    p Configure internationalization settings:

    pre
      code.language-php.
        public const string DEFAULT_LOCALE = 'en';
        public const bool REMEMBER_LOCALE = true;
        public const bool LOCALE_HEADERS = true;

        public const array LOCALES = [
            'en' => [
                'extensions' => ['.en'],
                'resources' => ['locales/messages.en.ftl'],
                'weight' => 1,
            ],
            'es' => [
                'extensions' => ['.es'],
                'resources' => ['locales/messages.es.ftl'],
                'weight' => 0.8,
            ],
        ];

  .content-section
    h2 Sensitive Configuration

    p Mark sensitive configuration parameters using the <code>\#[SensitiveParameter]</code> attribute:

    pre
      code.language-php.
        use F4\Config\SensitiveParameter;

        class Config extends AbstractConfig
        {
            #[SensitiveParameter]
            public const string DB_PASSWORD = '';

            #[SensitiveParameter]
            public const string API_SECRET_KEY = '';
        }

    .info-box
      strong Security:
      | Sensitive parameters are automatically redacted in debug output and error messages to prevent credential exposure.

  .content-section
    h2 Accessing Configuration at Runtime

    p Access configuration values through the <code>$f4</code> core API:

    pre
      code.language-php.
        // In a route handler
        $f4->addRoute(Route::get('/info', function() use ($f4) {
            $debugMode = $f4->config('DEBUG_MODE');
            $dbHost = $f4->config('DB_HOST');

            return [
                'debug' => $debugMode,
                'host' => $dbHost
            ];
        }));

        // In a module constructor
        class MyModule implements ModuleInterface
        {
            public function __construct(CoreApiInterface &$f4)
            {
                if ($f4->config('DEBUG_MODE')) {
                    // Add debug routes
                }
            }
        }

  .content-section
    h2 Environment-Specific Configuration Pattern

    p A common pattern for managing multiple environments:

    .demo-box
      h4 Project Structure

      pre.
        config/
        ├── default.php          # Shared configuration
        ├── local.example.php    # Template for local config
        └── local.php            # Local overrides (gitignored)

      h4 .gitignore

      pre.
        /config/local.php

      h4 Deployment

      ul
        li Development: Create <code>local.php</code> with dev settings
        li Staging: Create <code>local.php</code> with staging settings + env vars
        li Production: Use environment variables for all sensitive data

  .content-section
    h2 Complete Configuration Example

    pre
      code.language-php.
        namespace F4;

        use F4\AbstractConfig;
        use F4\Config\FromEnvironmentVariable as ENV;
        use F4\Config\SensitiveParameter;

        class Config extends AbstractConfig
        {
            // Debug settings
            #[ENV(name: 'F4_DEBUG_MODE')]
            public const bool DEBUG_MODE = false;

            #[ENV(name: 'F4_DEBUG_EXTENSION')]
            public const string DEBUG_EXTENSION = '+debug';

            // Database configuration
            #[ENV(name: 'DATABASE_HOST')]
            public const string DB_HOST = 'localhost';

            #[ENV(name: 'DATABASE_NAME')]
            public const string DB_NAME = 'myapp';

            #[ENV(name: 'DATABASE_USER')]
            public const string DB_USERNAME = 'dbuser';

            #[ENV(name: 'DATABASE_PASSWORD')]
            #[SensitiveParameter]
            public const string DB_PASSWORD = '';

            // Modules
            public const array MODULES = [
                \App\Auth\AuthModule::class,
                \App\Blog\BlogModule::class,
            ];

            // Templates
            public const array TEMPLATE_PATHS = [
                __DIR__ . '/../templates'
            ];
            public const bool TEMPLATE_CACHE_ENABLED = true;
            public const int TEMPLATE_CACHE_LIFETIME = 3600;

            // Sessions
            public const bool SESSION_ENABLED = true;
            public const bool SESSION_SECURE_ONLY = true;
            public const string SESSION_SAME_SITE = 'Strict';

            // Locales
            public const string DEFAULT_LOCALE = 'en';
            public const array LOCALES = [
                'en' => [
                    'extensions' => ['.en'],
                    'resources' => ['locales/messages.en.ftl'],
                    'weight' => 1
                ]
            ];
        }

  .content-section
    h2 Best Practices

    ol
      li <strong>Never commit secrets</strong> - Use <code>.gitignore</code> for <code>local.php</code>
      li <strong>Use environment variables</strong> for deployment-specific settings
      li <strong>Mark sensitive data</strong> with <code>\#[SensitiveParameter]</code>
      li <strong>Provide example files</strong> - Maintain <code>local.example.php</code>
      li <strong>Use type hints</strong> - Leverage PHP's type system for constants
      li <strong>Document custom settings</strong> - Add comments for non-obvious configuration
      li <strong>Environment-specific defaults</strong> - Set sensible defaults in <code>default.php</code>
      li <strong>Validate configuration</strong> - Check required settings at bootstrap
      li <strong>Use parent constants</strong> - Reference <code>parent::CONSTANT</code> when appropriate
      li <strong>Disable debug in production</strong> - Always set <code>DEBUG_MODE = false</code>

  .content-section
    h2 Common Configuration Patterns

    .demo-box
      h4 Pattern 1: Feature Flags

      pre
        code.language-php.
          public const bool FEATURE_NEW_EDITOR = false;
          public const bool FEATURE_BETA_API = true;

      h4 Pattern 2: Third-Party API Keys

      pre
        code.language-php.
          \#[ENV(name: 'STRIPE_API_KEY')]
          \#[SensitiveParameter]
          public const string STRIPE_API_KEY = '';

      h4 Pattern 3: Service URLs

      pre
        code.language-php.
          \#[ENV(name: 'API_BASE_URL')]
          public const string API_BASE_URL = 'https://api.example.com';

  .content-section
    h2 Try It Yourself

    p Practice exercises:

    ol
      li Create a <code>local.php</code> config file with custom database settings
      li Add environment variable support for an API key
      li Register a new module in the <code>MODULES</code> array
      li Configure multiple locales with different resource files
      li Create a feature flag and conditionally load routes based on it
      li Set up different cache lifetimes for development vs production

  .content-section
    h2 Key Takeaways

    ul
      li Configuration is class-based using constants extending <code>AbstractConfig</code>
      li Use <code>config/default.php</code> for shared config, <code>local.php</code> for overrides
      li Environment variables are read with <code>\#[ENV]</code> attribute
      li INI files are supported with <code>\#[INI]</code> attribute
      li Mark sensitive data with <code>\#[SensitiveParameter]</code>
      li Never commit <code>local.php</code> to version control
      li Access config at runtime with <code>$f4->config('CONSTANT_NAME')</code>
      li Configuration provides type safety and IDE support
      li Multiple environments are managed through config files and env vars
      li The framework provides sensible defaults in <code>AbstractConfig</code>
