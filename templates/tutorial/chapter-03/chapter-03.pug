extends ../tutorial.pug

block title
  | Chapter 3: Working with Templates - F4 Framework Tutorial

block content
  .chapter-header
    .chapter-number Chapter 3
    h1 Working with Templates
    p.description Master Pug templating in F4 - syntax, data binding, layout inheritance, and best practices

  .content-section
    h2 Introduction

    p F4 uses Pug (formerly Jade) as its template engine. Pug is a clean, whitespace-sensitive templating language that compiles to HTML. Unlike JavaScript-based Pug implementations, F4 templates use <strong>PHP syntax</strong> for expressions and logic.

    h3 What We'll Cover

    ul
      li Attaching templates to routes with setTemplate()
      li Pug syntax basics (indentation, tags, attributes)
      li Using PHP expressions in templates
      li Accessing template variables
      li Template inheritance with extends and blocks
      li Mixins for reusable components
      li Conditional rendering and loops
      li Including partials
      li Asset management with Vite
      li Best practices for template organization

  .content-section
    h2 Connecting Routes to Templates

    p Before diving into Pug syntax, you need to understand how templates are connected to your routes. Every route can specify which template should render its response.

    h3 Using setTemplate()

    pre
      code.language-php.
        use F4\Core\Route;

        // Define a route and attach a template
        $f4->addRoute(Route::get('/hello', function() {
            return [
                'message' => 'Hello World!',
                'timestamp' => date('Y-m-d H:i:s')
            ];
        })->setTemplate('hello.pug'));

    .info-box
      strong Key Concept:
      |  
      | The <code>setTemplate()</code> method tells F4 which Pug template file to use for rendering the response. The data you return from the route handler becomes available in the template as <code>$response['data']</code>.

    h3 Template Path Resolution

    p F4 looks for templates in the directories specified in your configuration:

    pre
      code.language-php.
        class Config extends AbstractConfig
        {
            public const array TEMPLATE_PATHS = [
                __DIR__ . '/../templates'
            ];
        }

    p Template paths are relative to these configured directories:

    table
      thead
        tr
          th Template String
          th Resolved File Path
      tbody
        tr
          td
            code hello.pug
          td
            code templates/hello.pug
        tr
          td
            code pages/about.pug
          td
            code templates/pages/about.pug
        tr
          td
            code user/profile.pug
          td
            code templates/user/profile.pug

    h3 Complete Example

    pre
      code.language-php.
        // Route handler returns data
        $f4->addRoute(Route::get('/users/{id:int}', function(int $id) {
            $user = User::find($id);

            // Return data to be passed to template
            return [
                'user' => $user,
                'pageTitle' => 'User Profile'
            ];
        })->setTemplate('user/profile.pug'));

    p In your template file (<code>templates/user/profile.pug</code>):

    pre
      code.language-pug.
        h1= $response['data']['pageTitle']

        .user-info
          h2= $response['data']['user']['name']
          p= 'Email: ' . $response['data']['user']['email']

    h3 Routes Without Templates

    p Not all routes need templates. API routes typically return JSON directly:

    pre
      code.language-php.
        $f4->addRoute(Route::get('/api/users/{id:int}.json', function(int $id) {
            return ['user' => User::find($id)];
        }));

    p F4 always needs to know how to render a route's response. There are two ways to tell F4 how to do it:
    ol
      li By using path suffix in your request, for example 
        code /api/users.json
        | , 
        code /products.html
        | , 
        code /rss.xml
      li By setting the default response format in your Config class:
        pre
          code
            span.keyword
              | public const string 
            span.variable
              | DEFAULT_RESPONSE_FORMAT = 
            span.string
              | 'application/json'
            | ;
          span.comment
            |  // emit JSON by default

  .content-section
    h2 Pug Syntax Basics

    p Pug uses indentation instead of closing tags. Each level of indentation represents nesting:

    h3 Basic Tags

    .demo-box
      h4 Pug Code

      pre
        code.language-pug.
          div
            h1 Welcome
            p This is a paragraph
            ul
              li First item
              li Second item

      h4 Compiled HTML

      pre
        code.language-html.
          &lt;div&gt;
            &lt;h1&gt;Welcome&lt;/h1&gt;
            &lt;p&gt;This is a paragraph&lt;/p&gt;
            &lt;ul&gt;
              &lt;li&gt;First item&lt;/li&gt;
              &lt;li&gt;Second item&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/div&gt;

    h3 Classes and IDs

    pre
      code.language-pug.
        //- Div with class
        .container
          h1.title My Title
          p.description.text-muted Description text

        //- Div with ID
        #header
          h1 Header Content

        //- Multiple classes
        button.btn.btn-primary.btn-lg Click Me

        //- Element with class and ID
        section#main-content.container
          p Content here

    .info-box
      strong Note:
      | By default, class and ID selectors create <code>div</code> elements. Use explicit tag names for other elements.

    h3 Attributes

    pre
      code.language-pug.
        //- Basic attributes
        a(href="/about" title="About Us") About

        //- Boolean attributes
        input(type="checkbox" checked)
        button(disabled) Submit

        //- Multiple attributes
        img(
          src="/images/logo.png"
          alt="Logo"
          width="200"
          height="100"
        )

        // Data attributes
        div(data-id="123" data-action="delete")

  .content-section
    h2 Using PHP in Templates

    p <strong>Important:</strong> F4's Pug templates use PHP syntax, not JavaScript!

    h3 Basic PHP Expressions

    pre
      code.language-pug.
        // Output a variable
        = $username

        // String concatenation
        = 'Hello, ' . $username

        // Array access
        = $user['name']

        // Object property
        = $post->title

        // Function calls
        = strtoupper($message)
        = date('Y-m-d')

    h3 String Concatenation in Output

    pre
      code.language-pug.
        // Text output with concatenation
        p= 'Welcome, ' . $username . '!'
        p= 'You have ' . $count . ' new messages.'

        // In attributes - build the value first
        - $userUrl = '/users/' . $userId
        a(href=$userUrl) View Profile

        - $imageSrc = '/images/' . $filename
        img(src=$imageSrc)

    .warning-box
      strong PHP Syntax:
      |  
      | Use PHP operators (<code>.</code> for concatenation, <code>-></code> for properties), not JavaScript (<code>+</code>, <code>.</code>).

  .content-section
    h2 Template Variables

    p Every F4 template receives several variables automatically:

    table
      thead
        tr
          th Variable
          th Type
          th Description
      tbody
        tr
          td
            code $response
          td array
          td Response data, headers, template info, exceptions
        tr
          td
            code $request
          td array
          td Request path, method, parameters, headers
        tr
          td
            code $config
          td array
          td Configuration constants
        tr
          td
            code $locale
          td string
          td Current locale (e.g., 'en', 'fr')
        tr
          td
            code $t
          td callable
          td Translation function

    h3 Accessing Response Data

    pre
      code.language-php.
        // Your route returns data in an array
        Route::get('/hello', function() {
            return [
                'message' => 'Hello World',
                'timestamp' => time()
            ];
        });

        // In template: access via $response['data']
        p= $response['data']['message']
        p= date('Y-m-d H:i:s', $response['data']['timestamp'])

    h3 Accessing Request Data

    pre
      code.language-pug.
        // Current path
        p= 'Current URL: ' . $request['path']

        // HTTP method
        p= 'Method: ' . $request['method']

        // Query parameters
        p= 'Page: ' . ($request['parameters']['page'] ?? 1)

  .content-section
    h2 Template Inheritance

    p Pug's template inheritance system allows you to create base layouts and extend them.

    h3 Base Layout

    pre
      code.language-pug.
        // File: templates/layout.pug
        doctype html
        html
          head
            title= $title ?? 'My App'
            meta(charset="utf-8")
            block styles
              link(rel="stylesheet" href="/css/app.css")

          body
            header
              block header
                h1 Default Header

            main
              block content
                p Default content

            footer
              block footer
                p © 2025 My App

            block scripts
              script(src="/js/app.js")

    h3 Extending Layout

    pre
      code.language-pug.
        // File: templates/home.pug
        extends layout.pug

        block title
          | Home - My App

        block content
          .container
            h1 Welcome Home
            p This is the home page content

        block scripts
          // Include parent block content
          block
          // Add additional script
          script(src="/js/home.js")

    .info-box
      strong Key Concept:
      |  
      | Blocks define placeholder regions that child templates can override or extend.

  .content-section
    h2 Conditional Rendering

    p Use PHP conditional statements for dynamic content:

    h3 If/Else Statements

    pre
      code.language-pug.
        // Basic if
        if ($isLoggedIn)
          p= 'Welcome back, ' . $username . '!'

        // If/else
        if ($count > 0)
          p= 'You have ' . $count . ' messages'
        else
          p No messages

        // If/elseif/else
        if ($role === 'admin')
          p Admin Dashboard
        elseif ($role === 'moderator')
          p Moderator Panel
        else
          p User Dashboard

    h3 Unless Statement

    pre
      code.language-pug.
        // Unless (if not)
        unless ($isLoggedIn)
          a(href="/login") Please log in

    h3 Ternary Operator

    pre
      code.language-pug.
        // In attributes
        button(class=$isActive ? 'btn-primary' : 'btn-secondary') Toggle

        // In text
        p= 'Status: ' . ($isOnline ? 'Online' : 'Offline')

  .content-section
    h2 Loops and Iteration

    p Iterate over arrays and objects using PHP loops:

    h3 Each Loop (foreach)

    pre
      code.language-pug.
        // Simple array
        ul
          each $item in $items
            li= $item

        // With index
        ul
          each $item, $index in $items
            li= ($index + 1) . '. ' . $item

        // Array of objects
        each $user in $users
          .user-card
            h3= $user['name']
            p= $user['email']

    h3 Handling Empty Arrays

    pre
      code.language-pug.
        ul
          each $post in $posts
            li= $post['title']
          else
            li No posts found

    h3 While Loop

    pre
      code.language-pug.
        - $i = 0
        ul
          while ($i < $count)
            li= 'Item ' . $i
            - $i++

  .content-section
    h2 Mixins (Reusable Components)

    p Mixins are reusable template blocks, similar to functions:

    h3 Defining Mixins

    pre
      code.language-pug.
        // Simple mixin
        mixin alert($message)
          .alert
            p= $message

        // Mixin with parameters
        mixin button($text, $type = 'primary')
          - $btnClass = 'btn btn-' . $type
          button(class=$btnClass)= $text

        // Mixin with block content
        mixin card($title)
          .card
            .card-header
              h3= $title
            .card-body
              block

    h3 Using Mixins

    pre
      code.language-pug.
        // Call simple mixin
        +alert('Welcome to our site!')

        // Call with different parameter
        +button('Submit')
        +button('Cancel', 'secondary')

        // Mixin with content block
        +card('User Profile')
          p= 'Name: ' . $user['name']
          p= 'Email: ' . $user['email']

  .content-section
    h2 Including Partials

    p Break templates into smaller, reusable files:

    h3 Include Syntax

    pre
      code.language-pug.
        // File: templates/layout.pug
        doctype html
        html
          head
            include partials/head.pug
          body
            header
              include partials/header.pug

            main
              block content

            footer
              include partials/footer.pug

    h3 Partial Files

    pre
      code.language-pug.
        // File: templates/partials/head.pug
        title= $title ?? 'My App'
        meta(charset="utf-8")
        meta(name="viewport" content="width=device-width, initial-scale=1")

        // File: templates/partials/header.pug
        nav.navbar
          a.logo(href="/") My App
          ul.nav-links
            li: a(href="/about") About
            li: a(href="/contact") Contact

  .content-section
    h2 Working with Assets

    p F4 uses Vite for asset management (both in development and production mode).

    h3 Linking CSS / Stylus and JavaScript

    pre
      code.language-pug.
        head
          // Tell Vite to include resources in a named bundle
          vite:resource(bundle="my_bundle" src="module.js")
          vite:resource(bundle="my_bundle" src="module.css")
          // Tell F4 to include bundled assets during page render
          vite:bundle(name="my_bundle")

    .warning-box
      strong Production build:
      |  
      | Vite uses different asset bundling methods for development and production servers, meaning that you have to run
      code
        | npm run build
      | before deploying your code to production.

    h3 Static Assets

    pre
      code.language-pug.
        // Public assets (in public/images/)
        img(src="/images/logo.png" alt="Logo")

        // Dynamic image path
        - $imageUrl = '/uploads/' . $imageName
        img(src=$imageUrl alt=$imageAlt)

  .content-section
    h2 Code Blocks

    p Execute PHP code without outputting:

    pre
      code.language-pug.
        // Define variables
        - $fullName = $firstName . ' ' . $lastName
        - $isActive = $status === 'active'

        // Multiple lines
        -
          $total = 0;
          foreach ($items as $item) {
              $total += $item['price'];
          }

        p= 'Total: $' . $total

  .content-section
    h2 Comments

    pre
      code.language-pug.
        //- Pug comment (not in output)
        //- This won't appear in HTML

        // HTML comment (in output)
        // This will be in the HTML

        //- Block comments
        //-
          This is a block comment
          Multiple lines
          Won't appear in output

  .content-section
    h2 Escaping and Raw HTML

    pre
      code.language-pug.
        // Escaped output (default - safe)
        p= $userInput  // HTML entities escaped

        // Unescaped output (use with caution!)
        p!= $trustedHtml  // Raw HTML output

        // Example
        - $html = '<strong>Bold</strong>'
        p= $html   // Shows: <strong>Bold</strong>
        p!= $html  // Shows: Bold (rendered)

    .warning-box
      strong Security:
      |  
      | Never use unescaped output (<code>!=</code>) with user input! This can lead to XSS vulnerabilities.

  .content-section
    h2 Template Organization

    p Recommended structure for organizing templates:

    .demo-box
      pre
        code.language-bash.
          templates/
          ├── layouts/
          │   ├── base.pug           # Main layout
          │   ├── admin.pug          # Admin layout
          │   └── auth.pug           # Authentication layout
          ├── partials/
          │   ├── head.pug           # &lt;head&gt; content
          │   ├── header.pug         # Site header
          │   ├── footer.pug         # Site footer
          │   └── nav.pug            # Navigation
          ├── components/
          │   ├── card.pug           # Card mixin
          │   ├── button.pug         # Button mixin
          │   └── form.pug           # Form components
          ├── pages/
          │   ├── home.pug
          │   ├── about.pug
          │   └── contact.pug
          └── errors/
              ├── 404.pug
              └── 500.pug

  .content-section
    h2 Best Practices

    ol
      li <strong>Use consistent indentation</strong> - 2 spaces is standard for Pug
      li <strong>Keep templates DRY</strong> - Use mixins and includes for repeated code
      li <strong>Leverage inheritance</strong> - Create layouts for common page structures
      li <strong>Escape user input</strong> - Use <code>=</code> not <code>!=</code> for untrusted data
      li <strong>Organize logically</strong> - Group related templates in folders
      li <strong>Use PHP syntax</strong> - Remember F4 uses PHP, not JavaScript
      li <strong>Keep logic minimal</strong> - Complex logic belongs in route handlers
      li <strong>Name variables clearly</strong> - Use descriptive names in template context
      li <strong>Comment complex sections</strong> - Help future developers understand
      li <strong>Test template output</strong> - Verify HTML structure and data binding

  .content-section
    h2 Common Patterns

    h3 Navigation with Active State

    pre
      code.language-pug.
        nav
          ul
            li(class=$request['path'] === '/' ? 'active' : '')
              a(href="/") Home
            li(class=$request['path'] === '/about' ? 'active' : '')
              a(href="/about") About

    h3 Pagination

    pre
      code.language-pug.
        nav.pagination
          if ($page > 1)
            - $prevUrl = '?page=' . ($page - 1)
            a(href=$prevUrl) Previous

          each $p in range(1, $totalPages)
            if ($p === $page)
              span.current= $p
            else
              - $pageUrl = '?page=' . $p
              a(href=$pageUrl)= $p

          if ($page < $totalPages)
            - $nextUrl = '?page=' . ($page + 1)
            a(href=$nextUrl) Next

    h3 Flash Messages

    pre
      code.language-pug.
        if (isset($session['flash']))
          each $message, $type in $session['flash']
            - $alertClass = 'alert-' . $type
            .alert(class=$alertClass)= $message
  .content-section
    h2 Try It Yourself

    p Practice exercises:

    ol
      li Create a base layout with header, content block, and footer
      li Make a reusable card mixin that accepts title and content
      li Build a navigation component that highlights the active page
      li Create a loop that displays a list of blog posts
      li Add conditional rendering to show/hide content based on user role
      li Make a form template with validation error display
      li Create an include partial for social media links
      li Build a breadcrumb navigation using the current path

  .content-section
    h2 Key Takeaways

    ul
      li Pug uses indentation-based syntax instead of closing tags
      li F4 templates use <strong>PHP syntax</strong>, not JavaScript
      li Access route data via <code>$response['data']</code>
      li Template variables: <code>$response</code>, <code>$request</code>, <code>$config</code>, <code>$locale</code>, <code>$t</code>
      li Use <code>extends</code> and <code>block</code> for template inheritance
      li Mixins create reusable components
      li <code>each</code> loops iterate over arrays with PHP syntax
      li <code>include</code> imports partial templates
      li Always escape user input with <code>=</code> operator
      li Keep templates organized in logical folder structures

  .content-section
    h2 What's Next?

    p Now that you understand how to work with templates, Chapter 4 will teach you parameter validation using PHP attributes to ensure data integrity and security!
