extends ../tutorial.pug

block title
  | Chapter 11: Debug Mode - F4 Framework Tutorial

block content
  .chapter-header
    .chapter-number Chapter 11
    h1 Debug Mode
    p.description Master F4's built-in debugger for profiling, inspecting requests, and troubleshooting

  .content-section
    h2 Introduction

    p F4 includes a sophisticated built-in debugger that provides deep insights into your application's execution. By simply adding a special suffix to any URL, you can access a comprehensive debugging interface that shows profiling data, database queries, request/response details, and much more.

    h3 What We'll Cover

    ul
      li Activating debug mode
      li Configuring the debug extension
      li Understanding the debugger interface
      li Profiling and performance analysis
      li Inspecting database queries
      li Request and response inspection
      li Route and middleware analysis
      li Logging and custom debug output
      li Template context inspection
      li Best practices for debugging

  .content-section
    h2 Activating Debug Mode

    p Debug mode is activated by adding a special suffix to any URL. By default, this suffix is <code>+debug</code>:

    .demo-box
      h4 Examples

      pre
        code.language-uri.
          # Normal request
          http://localhost:8000/tutorial

          # Debug mode request
          http://localhost:8000/tutorial+debug

          # Works with any route
          http://localhost:8000/users/123+debug
          http://localhost:8000/api/posts.json+debug

    .info-box
      strong Key Concept:
      | The debug suffix is stripped from the URL before routing, so <code>/tutorial+debug</code> matches the same route as <code>/tutorial</code>.

  .content-section
    h2 Configuring Debug Extension

    p You can customize the debug extension suffix in your configuration:

    pre
      code.language-php.
        namespace F4;

        use F4\AbstractConfig;

        class Config extends AbstractConfig
        {
            // Enable debug mode
            public const bool DEBUG_MODE = true;

            // Customize debug extension (default: '+debug')
            public const string DEBUG_EXTENSION = '+debug';

            // Enable query logging for debugger
            public const bool DEBUG_DB_QUERIES = true;
        }

    h3 Custom Debug Extensions

    .demo-box
      pre
        code.language-php.
          // Use different suffix
          public const string DEBUG_EXTENSION = '?debug';
          // Access: /tutorial?debug

          public const string DEBUG_EXTENSION = '.debug';
          // Access: /tutorial.debug

    .warning-box
      strong Security:
      | Always set <code>DEBUG_MODE = false</code> in production! The debugger exposes sensitive information about your application.

  .content-section
    h2 The Debugger Interface

    p When debug mode is active, F4 replaces the normal response with a comprehensive debugging interface containing multiple panels:

    table
      thead
        tr
          th Panel
          th Description
      tbody
        tr
          td Profiler
          td Timeline of request processing with execution times
        tr
          td Request
          td HTTP request details (method, path, headers, parameters)
        tr
          td Response
          td Response data, status code, headers, template info
        tr
          td Route
          td Matched route, handler code, middleware chain
        tr
          td Queries
          td All database queries with timing and results
        tr
          td Config
          td Complete configuration with values
        tr
          td Session
          td Session data and variables
        tr
          td Log
          td Custom log entries added via debugger
        tr
          td System
          td PHP version, extensions, F4 version, environment

  .content-section
    h2 Profiler Panel

    p The profiler shows a timeline of your application's execution with precise timing:

    .demo-box
      h4 Profiler Snapshots

      table
        thead
          tr
            th Event
            th Time (ms)
            th Memory
        tbody
          tr
            td Core ready
            td 2.5ms
            td 1.2MB
          tr
            td Setup request/response
            td 0.8ms
            td 1.3MB
          tr
            td Setup environment
            td 0.3ms
            td 1.3MB
          tr
            td Setup localizer
            td 1.2ms
            td 1.4MB
          tr
            td Register modules
            td 3.1ms
            td 1.5MB
          tr
            td Route matching
            td 0.5ms
            td 1.5MB
          tr
            td Execute query 1
            td 2.8ms
            td 1.6MB
          tr
            td Execute query 2
            td 1.5ms
            td 1.6MB
          tr
            td Prepare response
            td 0.4ms
            td 1.7MB
          tr
            td Render response
            td 5.2ms
            td 2.1MB

    p The profiler helps identify performance bottlenecks by showing:

    ul
      li Time spent in each phase
      li Memory usage at each snapshot
      li Database query timing
      li Template rendering time
      li Total request processing time

  .content-section
    h2 Request Inspection

    p The Request panel shows complete details about the incoming HTTP request:

    .demo-box
      h4 Request Information

      pre
        code.language-json.
          {
            "method": "GET",
            "path": "/tutorial/09-configuration",
            "extension": null,
            "debugExtension": "+debug",
            "headers": {
              "Host": ["localhost:8000"],
              "User-Agent": ["Mozilla/5.0..."],
              "Accept": ["text/html"]
            },
            "parameters": {
              "search": "config",
              "page": 2
            },
            "body": ""
          }

  .content-section
    h2 Response Inspection

    p The Response panel shows what your application is returning:

    .demo-box
      h4 Response Details

      pre
        code.language-json.
          {
            "code": 200,
            "status": "OK",
            "format": "text/html",
            "headers": {
              "Content-Type": ["text/html; charset=utf-8"]
            },
            "data": {
              "chapter": {
                "current": {"number": "09", "title": "Configuration"},
                "previous": {...},
                "next": {...}
              }
            },
            "template": {
              "path": "tutorial/chapter-09/chapter-09.pug",
              "context": {...},
              "folders": ["/path/to/templates"]
            },
            "exception": null
          }

    p The response panel is especially useful for:

    ul
      li Verifying data passed to templates
      li Checking HTTP status codes and headers
      li Inspecting template context
      li Debugging exceptions

  .content-section
    h2 Route Inspection

    p The Route panel shows detailed information about the matched route and its handler:

    .demo-box
      h4 Route Handler

      pre
        code.language-json.
          "file": "/app/src/App/Tutorial/TutorialModule.php"
          "line": 95
          "code":
            function() {
                return [
                    'chapter' => $this->getChapterInfo('09')
                ];
            }

      h4 Route Parameters

      pre
        code.language-json.
          {
            "id": 123,
            "slug": "my-post"
          }

      h4 Middleware Chain

      p Shows all middleware executed for this route:

      ul
        li Request middleware (global)
        li Route group request middleware
        li Route request middleware
        li Route response middleware
        li Route group response middleware
        li Response middleware (global)

  .content-section
    h2 Database Query Inspection

    p When <code>DEBUG_DB_QUERIES = true</code>, the debugger captures all SQL queries:

    .demo-box
      h4 Query Log

      pre
        code.
          Query 1: (2.8ms)
          SELECT * FROM users WHERE id = $1
          Parameters: [123]

          Query 2: (1.5ms)
          SELECT * FROM posts WHERE user_id = $1 ORDER BY created_at DESC
          Parameters: [123]

          Query 3: (0.8ms)
          UPDATE users SET last_seen = NOW() WHERE id = $1
          Parameters: [123]

    p For each query, you can see:

    ul
      li SQL statement with parameter placeholders
      li Actual parameter values
      li Execution time
      li Query order and timing in the profiler

    .info-box
      strong Performance Tip:
      | Use the query debugger to identify N+1 query problems and slow queries.

  .content-section
    h2 Custom Logging

    p Add custom debug logs using the debugger's <code>log()</code> method:

    pre
      code.language-php.
        $f4->addRoute(Route::get('/users/{id:int}', function(int $id) use ($f4) {
            // Log variable for debugging
            $f4->debug()->log($id, 'User ID parameter');

            $user = User::find($id);

            // Log complex objects
            $f4->debug()->log($user, 'Retrieved user object');

            // Log arrays
            $f4->debug()->log($user->toArray(), 'User data array');

            return ['user' => $user];
        }));

    h3 Log Entry Format

    .demo-box
      p Each log entry shows:

      ul
        li Description you provided
        li Variable value (expandable tree view)
        li Stack trace showing where the log was called
        li File and line number

  .content-section
    h2 Template Context Inspection

    p When a template is rendered, the debugger captures the complete template context:

    .demo-box
      pre
        code.language-json.
          {
            "request": {
              "method": "GET",
              "path": "/tutorial"
            },
            "response": {
              "data": {
                "chapters": [...],
                "message": "Hello"
              }
            },
            "session": {...},
            "locale": "en"
          }

    p This helps debug template issues by showing:

    ul
      li What data is available in the template
      li Variable names and values
      li Nested object structures
      li Helper functions and utilities

  .content-section
    h2 Configuration Inspection

    p The Config panel shows all configuration constants and their values:

    .demo-box
      pre
        code.language-json.
          {
            "DEBUG_MODE": true,
            "DEBUG_EXTENSION": "+debug",
            "DB_HOST": "localhost",
            "DB_NAME": "myapp",
            "DB_PASSWORD": "***REDACTED***",
            "TEMPLATE_CACHE_ENABLED": true,
            "MODULES": [
              "App\\Tutorial\\TutorialModule"
            ]
          }

    .warning-box
      strong Security:
      | Parameters marked with <code>\#[SensitiveParameter]</code> are automatically redacted in the debugger output.

  .content-section
    h2 Session Inspection

    p View all session variables and their values:

    pre
      code.language-json.
        {
          "user_id": 123,
          "is_admin": false,
          "cart": [
            {"id": 1, "quantity": 2},
            {"id": 5, "quantity": 1}
          ],
          "locale": "en"
        }

  .content-section
    h2 System Information

    p The System panel provides environment details:

    .demo-box
      h4 System Info

      pre
        code.language-json.
          {
            "F4 version": "1.0.0",
            "F4 environment": "local",
            "PHP version": "8.4.0",
            "PHP extensions": [
              "pdo_pgsql", "mbstring", "json"
            ],
            "OS info": "Darwin 24.6.0",
            "Project Root": "/Users/dev/myapp"
          }

  .content-section
    h2 Debugging Workflow

    h3 1. Identify Performance Issues

    pre
      code.language-bash.
        // Visit: /slow-page+debug
        // Check Profiler panel for slow operations
        // Look for:
        // - Long query execution times
        // - Slow middleware
        // - Template rendering bottlenecks

    h3 2. Debug Database Queries

    pre
      code.language-bash.
        // Visit: /users+debug
        // Check Queries panel
        // Look for:
        // - N+1 query problems
        // - Missing indexes (slow queries)
        // - Unnecessary queries

    h3 3. Inspect Request/Response

    pre
      code.language-bash.
        // Visit: /api/data+debug
        // Check Request panel for incoming data
        // Check Response panel for outgoing data
        // Verify headers, status codes, format

    h3 4. Debug Template Issues

    pre
      code.language-bash.
        // Visit: /page+debug
        // Check Response > template > context
        // Verify all variables are present
        // Check template path is correct

  .content-section
    h2 Custom Debugger Class

    p You can create a custom debugger by implementing <code>DebuggerInterface</code>:

    pre
      code.language-php.
        namespace App;

        use F4\Core\DebuggerInterface;
        use F4\Core\RequestInterface;

        class CustomDebugger implements DebuggerInterface
        {
            public function checkIfEnabledByRequest(RequestInterface $request): bool
            {
                // Custom logic for enabling debugger
                return $request->getDebugExtension() !== null;
            }

            public function log(mixed $value, ?string $description = null): void
            {
                // Custom logging implementation
            }

            public function captureAndEmit(callable $emitCallback): bool
            {
                // Custom debugger UI
                return true;
            }
        }

    h3 Configure Custom Debugger

    pre
      code.language-php.
        class Config extends AbstractConfig
        {
            public const string CORE_DEBUGGER_CLASS = \App\CustomDebugger::class;
        }

  .content-section
    h2 Best Practices

    ol
      li <strong>Never enable in production</strong> - Set <code>DEBUG_MODE = false</code>
      li <strong>Use environment variables</strong> - Control debug mode via env vars
      li <strong>Profile regularly</strong> - Check performance during development
      li <strong>Log strategically</strong> - Add debug logs at key decision points
      li <strong>Check queries</strong> - Monitor database query counts and timing
      li <strong>Inspect middleware</strong> - Verify middleware execution order
      li <strong>Validate templates</strong> - Ensure correct data reaches templates
      li <strong>Review exceptions</strong> - Check exception details in debugger
      li <strong>Monitor memory</strong> - Watch memory usage in profiler
      li <strong>Test debug mode</strong> - Ensure it works before you need it

  .content-section
    h2 Common Use Cases

    .demo-box
      h4 Use Case 1: Finding N+1 Query Problems

      pre
        code.language-bash.
          // Visit: /posts+debug
          // Look in Queries panel
          // If you see:
          //   Query 1: SELECT * FROM posts
          //   Query 2: SELECT * FROM users WHERE id = 1
          //   Query 3: SELECT * FROM users WHERE id = 2
          //   Query 4: SELECT * FROM users WHERE id = 3
          // You have an N+1 problem - use joins instead!

      h4 Use Case 2: Debugging Missing Template Variables

      pre
        code.language-bash.
          // Visit: /page+debug
          // Check Response > template > context
          // Verify expected variables exist
          // Check variable names and structure

      h4 Use Case 3: Profiling Slow Requests

      pre
        code.language-bash.
          // Visit: /slow-endpoint+debug
          // Check Profiler panel
          // Identify which phase is slow
          // Optimize that specific component

  .content-section
    h2 Try It Yourself

    p Practice exercises:

    ol
      li Enable debug mode on this tutorial page by adding <code>+debug</code> to the URL
      li Explore the profiler to see how long each phase takes
      li Check the Request panel to see your browser headers
      li Look at the Response > template > context to see chapter data
      li Try adding custom debug logs in your route handlers
      li Profile a page with database queries
      li Inspect the middleware chain for a route
      li View configuration values in the Config panel

  .content-section
    h2 Key Takeaways

    ul
      li Debug mode is activated by adding <code>+debug</code> (or custom suffix) to any URL
      li Configure debug extension with <code>DEBUG_EXTENSION</code> constant
      li The debugger provides comprehensive insights into request processing
      li Profiler shows timing and memory usage for each phase
      li Query panel captures all database queries with timing
      li Custom logs can be added with <code>$f4->debug()->log()</code>
      li Template context shows all variables available in templates
      li Sensitive parameters are automatically redacted
      li Always disable debug mode in production (<code>DEBUG_MODE = false</code>)
      li The debugger is an essential tool for performance optimization

  .content-section
    h2 What's Next?

    p Now that you understand how to use F4's debug mode, the final step is learning how to deploy your application to production! Continue to Chapter 12 to learn about building assets, configuring production servers, and deployment best practices.
